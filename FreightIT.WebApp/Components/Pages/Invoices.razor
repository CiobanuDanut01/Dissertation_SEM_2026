@page "/invoices"
@rendermode InteractiveServer

@* --- Imports for HTTP calls and validation --- *@
@using System.Net.Http.Json
@using System.ComponentModel.DataAnnotations
@inject IHttpClientFactory HttpClientFactory

<PageTitle>FreightIT - Invoices</PageTitle>

<h1>Invoice Management</h1>

@* --- CREATE NEW INVOICE FORM --- *@
<div class="card shadow-sm mb-4">
    <div class="card-header">
        <h3>Create New Invoice</h3>
    </div>
    <div class="card-body">
        <EditForm Model="@newInvoice" OnValidSubmit="@HandleCreateInvoice">
            <AntiforgeryToken />
            <DataAnnotationsValidator />

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Invoice Number</label>
                    <InputText class="form-control" @bind-Value="newInvoice.InvoiceNumber" />
                    <ValidationMessage For="@(() => newInvoice.InvoiceNumber)" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Client Name</label>
                    <InputText class="form-control" @bind-Value="newInvoice.ClientName" />
                    <ValidationMessage For="@(() => newInvoice.ClientName)" />
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Amount</label>
                    <InputNumber class="form-control" @bind-Value="newInvoice.Amount" />
                    <ValidationMessage For="@(() => newInvoice.Amount)" />
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Due Date</label>
                    <InputDate class="form-control" @bind-Value="newInvoice.DueDate" />
                    <ValidationMessage For="@(() => newInvoice.DueDate)" />
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Status</label>
                    <InputText class="form-control" @bind-Value="newInvoice.Status" />
                    <ValidationMessage For="@(() => newInvoice.Status)" />
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">
                <span class="bi bi-plus-circle-fill"></span> Create Invoice
            </button>
        </EditForm>
    </div>
</div>
@* --- END OF FORM --- *@


<h2>Current Invoices</h2>

@* --- INVOICE LIST TABLE --- *@
@if (invoices == null)
{
    <p><em>Loading invoices... please wait.</em></p>
}
else if (invoices.Length == 0)
{
    <p><em>No invoices found in the database.</em></p>
}
else
{
    <table class="table table-striped table-hover shadow-sm rounded-3">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Invoice Number</th>
                <th>Client Name</th>
                <th>Amount</th>
                <th>Due Date</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var invoice in invoices)
            {
                <tr>
                    <td>@invoice.Id</td>
                    <td>@invoice.InvoiceNumber</td>
                    <td>@invoice.ClientName</td>
                    <td>@invoice.Amount.ToString("C")</td>
                    <td>@invoice.DueDate.ToShortDateString()</td>
                    <td>
                        <span class="badge @GetStatusBadgeClass(invoice.Status)">
                            @invoice.Status
                        </span>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}


@* --- C# CODE SECTION --- *@
@code {
    // Holds the list of invoices
    private Invoice[]? invoices;

    // Holds the data for the "Create New Invoice" form
    private Invoice newInvoice = new();

    // Holds our HTTP client for API calls
    private HttpClient? httpClient;

    // Runs automatically when the page loads
    protected override async Task OnInitializedAsync()
    {
        // Create the HTTP client for InvoiceService
        httpClient = HttpClientFactory.CreateClient("InvoiceService");
        
        // Load the initial list of invoices
        await LoadInvoicesAsync();
    }

    // Loads invoices from the API
    private async Task LoadInvoicesAsync()
    {
        if (httpClient == null) return;

        try
        {
            // Make the GET call to the API
            invoices = await httpClient.GetFromJsonAsync<Invoice[]>("/invoices");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching invoices: {ex.Message}");
            invoices = Array.Empty<Invoice>();
        }
    }

    // Handles the form submission to create a new invoice
    private async Task HandleCreateInvoice()
    {
        Console.WriteLine("HandleCreateInvoice called!");
        
        if (httpClient == null)
        {
            Console.WriteLine("ERROR: httpClient is null!");
            return;
        }
        
        Console.WriteLine($"Creating invoice: {newInvoice.InvoiceNumber} - {newInvoice.ClientName}");
        
        try
        {
            // Make the POST call to create a new invoice
            var response = await httpClient.PostAsJsonAsync("/invoices", newInvoice);

            Console.WriteLine($"Response status: {response.StatusCode}");

            // Check if the call was successful
            if (response.IsSuccessStatusCode)
            {
                Console.WriteLine("Invoice created successfully!");
                
                // Clear the form by resetting newInvoice
                newInvoice = new();

                // Reload the list to show the new invoice
                await LoadInvoicesAsync();
            }
            else
            {
                // The API returned an error
                var errorContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error creating invoice: {errorContent}");
            }
        }
        catch (Exception ex)
        {
            // The HTTP call failed
            Console.WriteLine($"Exception creating invoice: {ex.Message}");
        }
    }

    // Helper method to get Bootstrap badge class based on status
    private string GetStatusBadgeClass(string? status)
    {
        return status?.ToLower() switch
        {
            "paid" => "bg-success",
            "pending" => "bg-warning",
            "overdue" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    // The Invoice class - defines what data an invoice has
    public class Invoice
    {
        public int Id { get; set; }
        
        [Required]
        public string? InvoiceNumber { get; set; }
        
        [Required]
        public decimal Amount { get; set; }
        
        [Required]
        public string? ClientName { get; set; }
        
        public DateTime DueDate { get; set; } = DateTime.Today.AddDays(30);
        
        [Required]
        public string? Status { get; set; } = "Pending";
    }
}

