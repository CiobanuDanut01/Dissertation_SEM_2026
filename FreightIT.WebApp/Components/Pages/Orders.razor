@page "/orders"
@rendermode InteractiveServer

@* --- Imports for HTTP calls and validation --- *@
@using System.Net.Http.Json
@using System.ComponentModel.DataAnnotations
@inject IHttpClientFactory HttpClientFactory

<PageTitle>FreightIT - Orders</PageTitle>

<h1>Transport Order Management</h1>

@* --- CREATE NEW ORDER FORM --- *@
<div class="card shadow-sm mb-4">
    <div class="card-header">
        <h3>Create New Transport Order</h3>
    </div>
    <div class="card-body">
        <EditForm Model="@newOrder" OnValidSubmit="@HandleCreateOrder">
            <AntiforgeryToken />
            <DataAnnotationsValidator />

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Origin Address</label>
                    <InputText class="form-control" @bind-Value="newOrder.OriginAddress" />
                    <ValidationMessage For="@(() => newOrder.OriginAddress)" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Destination Address</label>
                    <InputText class="form-control" @bind-Value="newOrder.DestinationAddress" />
                    <ValidationMessage For="@(() => newOrder.DestinationAddress)" />
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Pickup Date</label>
                    <InputDate class="form-control" @bind-Value="newOrder.PickupDate" />
                    <ValidationMessage For="@(() => newOrder.PickupDate)" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Delivery Date</label>
                    <InputDate class="form-control" @bind-Value="newOrder.DeliveryDate" />
                    <ValidationMessage For="@(() => newOrder.DeliveryDate)" />
                </div>
            </div>

            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Driver</label>
                    <InputSelect class="form-select" @bind-Value="newOrder.DriverId">
                        <option value="0">-- Select Driver --</option>
                        @if (drivers != null)
                        {
                            @foreach (var driver in drivers)
                            {
                                <option value="@driver.Id">@driver.FirstName @driver.LastName</option>
                            }
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => newOrder.DriverId)" />
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Truck</label>
                    <InputSelect class="form-select" @bind-Value="newOrder.TruckId">
                        <option value="0">-- Select Truck --</option>
                        @if (trucks != null)
                        {
                            @foreach (var truck in trucks)
                            {
                                <option value="@truck.Id">@truck.LicensePlate (@truck.Make @truck.Model)</option>
                            }
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => newOrder.TruckId)" />
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Invoice</label>
                    <InputSelect class="form-select" @bind-Value="newOrder.InvoiceId">
                        <option value="0">-- Select Invoice --</option>
                        @if (invoices != null)
                        {
                            @foreach (var invoice in invoices)
                            {
                                <option value="@invoice.Id">@invoice.InvoiceNumber - @invoice.ClientName</option>
                            }
                        }
                    </InputSelect>
                    <ValidationMessage For="@(() => newOrder.InvoiceId)" />
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Status</label>
                    <InputText class="form-control" @bind-Value="newOrder.Status" />
                    <ValidationMessage For="@(() => newOrder.Status)" />
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">
                <span class="bi bi-plus-circle-fill"></span> Create Order
            </button>
        </EditForm>
    </div>
</div>
@* --- END OF FORM --- *@


<h2>Current Transport Orders</h2>

@* --- ORDERS LIST TABLE --- *@
@if (orders == null)
{
    <p><em>Loading orders... please wait.</em></p>
}
else if (orders.Length == 0)
{
    <p><em>No transport orders found in the database.</em></p>
}
else
{
    <table class="table table-striped table-hover shadow-sm rounded-3">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Origin</th>
                <th>Destination</th>
                <th>Pickup Date</th>
                <th>Delivery Date</th>
                <th>Status</th>
                <th>Driver</th>
                <th>Truck</th>
                <th>Invoice</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var order in orders)
            {
                <tr>
                    <td>@order.Id</td>
                    <td>@order.OriginAddress</td>
                    <td>@order.DestinationAddress</td>
                    <td>@order.PickupDate.ToShortDateString()</td>
                    <td>@order.DeliveryDate.ToShortDateString()</td>
                    <td>
                        <span class="badge @GetStatusBadgeClass(order.Status)">
                            @order.Status
                        </span>
                    </td>
                    <td>@GetDriverName(order.DriverId)</td>
                    <td>@GetTruckInfo(order.TruckId)</td>
                    <td>@GetInvoiceNumber(order.InvoiceId)</td>
                    <td>
                        <button class="btn btn-info btn-sm" @onclick="@(() => GetAiRoute(order))">
                            <span class="bi bi-robot"></span> Get Route
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@* --- AI ROUTE RESPONSE MODAL --- *@
@if (aiRouteResponse != null)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <span class="bi bi-robot"></span> AI Route Recommendation
                    </h5>
                    <button type="button" class="btn-close" @onclick="@(() => aiRouteResponse = null)"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>AI Response:</strong>
                        <p class="mt-2 mb-0">@aiRouteResponse</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="@(() => aiRouteResponse = null)">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
}


@* --- C# CODE SECTION --- *@
@code {
    // === "BOXES" (Fields) to hold our data ===
    private TransportOrder[]? orders;
    private Driver[]? drivers;
    private Truck[]? trucks;
    private Invoice[]? invoices;
    private TransportOrder newOrder = new();
    private string? aiRouteResponse; // To hold the AI's answer

    // === "PHONES" (HttpClients) for all services ===
    private HttpClient? orderHttp;
    private HttpClient? driverHttp;
    private HttpClient? truckHttp;
    private HttpClient? invoiceHttp;
    private HttpClient? routeHttp;

    // === Runs automatically when the page loads ===
    protected override async Task OnInitializedAsync()
    {
        // 1. "Hire" all 5 HttpClients from the HttpClientFactory
        orderHttp = HttpClientFactory.CreateClient("OrderService");
        driverHttp = HttpClientFactory.CreateClient("DriverService");
        truckHttp = HttpClientFactory.CreateClient("TruckService");
        invoiceHttp = HttpClientFactory.CreateClient("InvoiceService");
        routeHttp = HttpClientFactory.CreateClient("RouteService");

        // 2. Load all data in parallel for better performance
        await Task.WhenAll(
            LoadOrdersAsync(),
            LoadDriversAsync(),
            LoadTrucksAsync(),
            LoadInvoicesAsync()
        );
    }

    // === LOAD METHODS - Each one fetches data from its service ===

    private async Task LoadOrdersAsync()
    {
        if (orderHttp == null) return;
        try
        {
            orders = await orderHttp.GetFromJsonAsync<TransportOrder[]>("/orders");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching orders: {ex.Message}");
            orders = Array.Empty<TransportOrder>();
        }
    }

    private async Task LoadDriversAsync()
    {
        if (driverHttp == null) return;
        try
        {
            drivers = await driverHttp.GetFromJsonAsync<Driver[]>("/drivers");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching drivers: {ex.Message}");
            drivers = Array.Empty<Driver>();
        }
    }

    private async Task LoadTrucksAsync()
    {
        if (truckHttp == null) return;
        try
        {
            trucks = await truckHttp.GetFromJsonAsync<Truck[]>("/trucks");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching trucks: {ex.Message}");
            trucks = Array.Empty<Truck>();
        }
    }

    private async Task LoadInvoicesAsync()
    {
        if (invoiceHttp == null) return;
        try
        {
            invoices = await invoiceHttp.GetFromJsonAsync<Invoice[]>("/invoices");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching invoices: {ex.Message}");
            invoices = Array.Empty<Invoice>();
        }
    }

    // === CREATE ORDER HANDLER ===
    private async Task HandleCreateOrder()
    {
        Console.WriteLine("HandleCreateOrder called!");
        
        if (orderHttp == null)
        {
            Console.WriteLine("ERROR: orderHttp is null!");
            return;
        }
        
        Console.WriteLine($"Creating order: {newOrder.OriginAddress} -> {newOrder.DestinationAddress}");
        
        try
        {
            // Make the POST call to create a new order
            var response = await orderHttp.PostAsJsonAsync("/orders", newOrder);

            Console.WriteLine($"Response status: {response.StatusCode}");

            if (response.IsSuccessStatusCode)
            {
                Console.WriteLine("Order created successfully!");
                
                // Clear the form
                newOrder = new();

                // Reload the orders list
                await LoadOrdersAsync();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error creating order: {errorContent}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception creating order: {ex.Message}");
        }
    }

    // === AI ROUTE METHOD ===
    private async Task GetAiRoute(TransportOrder order)
    {
        Console.WriteLine($"GetAiRoute called for order {order.Id}");
        
        if (routeHttp == null)
        {
            Console.WriteLine("ERROR: routeHttp is null!");
            return;
        }

        try
        {
            // Create the route request
            var routeRequest = new RouteRequest(order.OriginAddress ?? "", order.DestinationAddress ?? "");
            
            // POST to the route recommendation endpoint
            var response = await routeHttp.PostAsJsonAsync("/route/recommend", routeRequest);

            Console.WriteLine($"Route response status: {response.StatusCode}");

            if (response.IsSuccessStatusCode)
            {
                // Get the string response and save it
                aiRouteResponse = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"AI Route Response: {aiRouteResponse}");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error getting route: {errorContent}");
                aiRouteResponse = $"Error: {errorContent}";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception getting route: {ex.Message}");
            aiRouteResponse = $"Exception: {ex.Message}";
        }
    }

    // === HELPER METHODS for displaying related data ===
    
    private string GetDriverName(int driverId)
    {
        var driver = drivers?.FirstOrDefault(d => d.Id == driverId);
        return driver != null ? $"{driver.FirstName} {driver.LastName}" : $"ID:{driverId}";
    }

    private string GetTruckInfo(int truckId)
    {
        var truck = trucks?.FirstOrDefault(t => t.Id == truckId);
        return truck != null ? truck.LicensePlate ?? $"ID:{truckId}" : $"ID:{truckId}";
    }

    private string GetInvoiceNumber(int invoiceId)
    {
        var invoice = invoices?.FirstOrDefault(i => i.Id == invoiceId);
        return invoice != null ? invoice.InvoiceNumber ?? $"ID:{invoiceId}" : $"ID:{invoiceId}";
    }

    private string GetStatusBadgeClass(string? status)
    {
        return status?.ToLower() switch
        {
            "completed" => "bg-success",
            "enroute" => "bg-primary",
            "pending" => "bg-warning",
            _ => "bg-secondary"
        };
    }

    // === BLUEPRINTS (Lite classes) - Define what the data looks like ===

    public record RouteRequest(string Origin, string Destination);

    public class TransportOrder
    {
        public int Id { get; set; }
        
        [Required]
        public string? OriginAddress { get; set; }
        
        [Required]
        public string? DestinationAddress { get; set; }
        
        public DateTime PickupDate { get; set; } = DateTime.Today;
        
        public DateTime DeliveryDate { get; set; } = DateTime.Today.AddDays(3);
        
        [Required]
        public string? Status { get; set; } = "Pending";
        
        [Required]
        [Range(1, int.MaxValue, ErrorMessage = "Please select a driver")]
        public int DriverId { get; set; }
        
        [Required]
        [Range(1, int.MaxValue, ErrorMessage = "Please select a truck")]
        public int TruckId { get; set; }
        
        [Required]
        [Range(1, int.MaxValue, ErrorMessage = "Please select an invoice")]
        public int InvoiceId { get; set; }
        
        public string? RecommendedRoute { get; set; }
    }

    public class Driver
    {
        public int Id { get; set; }
        public string? FirstName { get; set; }
        public string? LastName { get; set; }
        public string? LicenseNumber { get; set; }
        public DateTime DateOfBirth { get; set; }
    }

    public class Truck
    {
        public int Id { get; set; }
        public string? LicensePlate { get; set; }
        public string? Make { get; set; }
        public string? Model { get; set; }
        public int Year { get; set; }
        public int Mileage { get; set; }
    }

    public class Invoice
    {
        public int Id { get; set; }
        public string? InvoiceNumber { get; set; }
        public decimal Amount { get; set; }
        public string? ClientName { get; set; }
        public DateTime DueDate { get; set; }
        public string? Status { get; set; }
    }
}

